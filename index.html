<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ä»Šæœˆã„ãã‚‰ç¨¼ã„ã ãƒ‰ãƒ³ï¼Ÿ</title>
  <meta name="theme-color" content="#0b0c10">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    :root{--bg:#0e0f13;--fg:#f7f8fa;--muted:#9aa0a6;--accent:#ffd54f;--glass:rgba(255,255,255,.06);--glass-strong:rgba(255,255,255,.12)}
    html,body{height:100vh;margin:0;background:radial-gradient(1200px 800px at 50% 20%,#151823,#0b0c10);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{position:relative;height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
    .counter-card{background: transparent; box-shadow:0 10px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06);backdrop-filter:blur(8px);border:0}
    .title{letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .amount{font-variant-numeric:tabular-nums;font-weight:800;text-shadow:0 3px 14px rgba(0,0,0,.25);color:white}
    .note{color:var(--muted)}
    .progress{background:var(--glass);border-radius:999px;overflow:hidden}
    .bar{background:linear-gradient(90deg,#ffd54f,#ff9f1c);box-shadow:0 0 18px rgba(255,165,0,.45);transition:width .2s linear}
    .chrome{position:absolute;top:16px;right:16px;z-index:5}
    .btn{background:var(--glass-strong);color:var(--fg);border:0;font-weight:600;backdrop-filter:blur(10px)}
    .btn:active{transform:translateY(1px)}
    .modal-backdrop{background-color:rgba(0,0,0,.45)}
    .panel{background:#12131a;border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .form-label{color:var(--muted)}
    .form-control{background:#0e0f13;color:var(--fg);border:1px solid rgba(255,255,255,.12)}
    .form-control:focus{background:#0e0f13;color:var(--fg);border-color:rgba(255,255,255,.24);box-shadow:0 0 0 .2rem rgba(255,255,255,.1)}
    .hint{color:var(--muted)}
    .provider{position:absolute;left:16px;bottom:12px;color:var(--muted);font-size:11px;opacity:.8}

    /* å¤‰æ›´: ã‚«ãƒ¼ãƒ‰UIã‚’å®Œå…¨ã«é€éã—ã€ã‚³ã‚¤ãƒ³ã‚’èƒŒå¾Œã«é…ç½®ã™ã‚‹ */
    .card.counter-card,
    .card.counter-card *,
    .card.counter-card > .card-body,
    .card.counter-card .card-body {
      background: transparent !important;
      background-color: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
    }

    .counter-card{ position: relative !important; z-index: 2 !important; }
    .coins{ position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index:0 }
    .coin{
      position:absolute;
      width:clamp(16px,5vw,28px);
      will-change:transform,opacity;
      filter:drop-shadow(0 6px 6px rgba(0,0,0,.25));
      /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ duration ã‚’é•·ã‚ã«ã—ã¦ä¸Šæ˜‡ã‚’ã‚†ã£ãã‚Šã«ã™ã‚‹ */
      animation:floatUp var(--duration,4.0s) cubic-bezier(.2,.9,.3,1) forwards;
      opacity:0;
      /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•° */
      --x: 0px; --s: 1; --rise: 200px;
    }

    @keyframes floatUp {
      0% {
        transform: translate(var(--x, 0), 0) translate(-50%, -50%) scale(var(--s, 0.8)) rotate(0turn);
        opacity: 0;
      }
      8% { opacity: 1; }
      70% { opacity: 1; }
      100% {
        /* æ°´å¹³ç§»å‹•ã‚’å¢—å¹…ã—ã¦â€œå¤–å´ã¸é£›ã‚“ã§ã„ãâ€ã‚ˆã†ã«ã™ã‚‹ */
        transform: translate(calc(var(--x, 0) * 2.5), calc(-1 * var(--rise, 200px))) translate(-50%, -50%) scale(1) rotate(1turn);
        opacity: 0;
      }
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯å¸¸ã«æœ€å‰é¢ */
    .modal { z-index: 2000; }

    /* å¼·åˆ¶ä¸Šæ›¸ã: .wrap é…ä¸‹ã®ã‚«ãƒ¼ãƒ‰/UI ã®èƒŒæ™¯ãƒ»å½±ãƒ»ç–‘ä¼¼è¦ç´ ã‚’å®Œå…¨ã«æ¶ˆã™ */
    .wrap .card.counter-card,
    .wrap .card.counter-card .card-body,
    .wrap .card.counter-card *,
    .wrap .card.counter-card::before,
    .wrap .card.counter-card::after {
      background: transparent !important;
      background-color: transparent !important;
      box-shadow: none !important;
      border: 0 !important;
      color: inherit !important;
    }

    /* è¿½åŠ : amount ç­‰ã®å€‹åˆ¥è¦ç´ ãŒèƒŒæ™¯ã‚’æŒã¤å ´åˆã«ã‚‚ç„¡åŠ¹åŒ– */
    .wrap .card.counter-card .display-1,
    .wrap .card.counter-card .card-title,
    .wrap .card.counter-card .progress {
      background: transparent !important;
      box-shadow: none !important;
    }

    /* coins ã¨ UI ã®é‡ãªã‚Šé †ã‚’æ˜ç¤º */
    .wrap { position: relative; z-index: 0; }
    .coins { position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index: 0 !important; }
    .card.counter-card { position: relative; z-index: 1 !important; }
    
    /* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠï¼šå›½æ——ã¨ã‚«ãƒ¼ãƒ‰ã‚’ã¾ã¨ã‚ã‚‹è¦ªè¦ç´  */
    .card-container {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* ãƒ™ãƒˆãƒŠãƒ å›½æ——ã®è£…é£¾ */
    .flag-decoration {
      position: absolute;
      /* ã‚«ãƒ¼ãƒ‰ã®ä¸Šã«é…ç½®ï¼ˆãƒ”ã‚¯ã‚»ãƒ«æŒ‡å®šã§å›ºå®šï¼‰ */
      top: -100px;
      width: 200px;
      height: auto;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.3));
      z-index: 3;
    }
  </style>
</head>
<body>
  <div class="wrap">    
    <div class="chrome">
      <button class="btn btn-sm me-2" id="btn-settings" aria-label="è¨­å®šã‚’é–‹ã">âš™ï¸ è¨­å®š</button>
      <button class="btn btn-sm" id="btn-boost" aria-label="ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™">ğŸª™ ã˜ã‚ƒã°ã˜ã‚ƒã°</button>
    </div>

    <!-- ã‚«ãƒ¼ãƒ‰ã¨ãã®ä¸Šã®å›½æ——ã‚’åŒã˜divã§åŒ…ã‚“ã§ç›¸å¯¾ä½ç½®é–¢ä¿‚ã‚’å›ºå®š -->
    <div class="card-container">
      <!-- å›½æ——ã‚’ã‚«ãƒ¼ãƒ‰å†…ã«é…ç½® -->
      <img src="flag.svg" alt="Vietnam Flag" class="flag-decoration">
      
      <div class="card counter-card p-4 p-md-5" aria-live="polite" style="min-width: min(92vw, 700px);">
        <div class="card-body text-center">
          <h5 class="card-title title mb-3">ä»Šæœˆã“ã‚Œã ã‘ç¨¼ã„ã ãƒ‰ãƒ³ï¼</h5>
          <div class="amount display-1 mb-3" id="amount">â‚«0</div>
          <p class="note mb-4" id="subnote">è¨­å®šã‹ã‚‰æœˆåãƒ»çµ¦æ–™æ—¥ãƒ»åŸºæº–é€šè²¨ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
          <div class="progress mb-0" style="height: 10px;">
            <div class="bar progress-bar" id="bar" role="progressbar" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="coins" id="coins"></div>
    <div class="provider">FX data: exchangerate-api.comï¼ˆå‚è€ƒãƒ¬ãƒ¼ãƒˆï¼‰</div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content panel">
        <div class="modal-header border-0">
          <h5 class="modal-title">è¨­å®š</h5>
        </div>
        <div class="modal-body">
          <form>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="salary" class="form-label">æœˆå</label>
                <input type="number" class="form-control" id="salary" inputmode="decimal" min="0" step="1000" placeholder="ä¾‹: 400000">
              </div>
              <div class="col-md-6">
                <label for="currency" class="form-label">åŸºæº–é€šè²¨ï¼ˆå…¥åŠ›ã®é€šè²¨ï¼‰</label>
                <select class="form-select" id="currency">
                  <option value="JPY" selected>JPYï¼ˆå††ï¼‰</option>
                  <option value="USD">USDï¼ˆ$ï¼‰</option>
                  <option value="EUR">EURï¼ˆâ‚¬ï¼‰</option>
                  <option value="VND">VNDï¼ˆâ‚«ï¼‰</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="payday" class="form-label">çµ¦æ–™æ—¥ï¼ˆæ¯æœˆã®â—‹æ—¥ï¼‰</label>
                <input type="number" class="form-control" id="payday" inputmode="numeric" min="1" max="31" placeholder="ä¾‹: 25">
              </div>
              <div class="col-md-6">
                <label for="decimals" class="form-label">å°æ•°è¡¨ç¤º</label>
                <select class="form-select" id="decimals">
                  <option value="0" selected>ã—ãªã„</option>
                  <option value="2">2æ¡</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="displayCurrency" class="form-label">è¡¨ç¤ºé€šè²¨ï¼ˆå›ºå®šï¼‰</label>
                <input type="text" class="form-control" id="displayCurrency" value="VND" disabled>
              </div>
              <div class="col-md-6">
                <label for="rateView" class="form-label">ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆ</label>
                <input type="text" class="form-control" id="rateView" disabled placeholder="è‡ªå‹•å–å¾—ä¸­â€¦">
              </div>
            </div>
            <div class="hint mt-3">â€» ãƒ¬ãƒ¼ãƒˆã¯exchangerate-api.comã‹ã‚‰è‡ªå‹•å–å¾—ï¼ˆå‚è€ƒå€¤ï¼‰ã€‚å–å¾—å¤±æ•—æ™‚ã®ã¿æœ€å¾Œã®ä¿å­˜å€¤ã‚’ä½¿ç”¨ã€‚</div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" id="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" id="btn-save">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const LS_KEY = "earning-counter:v2"; // v2: VNDè‡ªå‹•ãƒ¬ãƒ¼ãƒˆå¯¾å¿œ
    const RATE_CACHE_KEY = "earning-rate-cache:vnd";
    const $ = (sel) => document.querySelector(sel);

    const state = {
      salary: 0,         // å…¥åŠ›æœˆåï¼ˆåŸºæº–é€šè²¨å»ºã¦ï¼‰
      payday: 25,
      currency: "JPY",   // åŸºæº–é€šè²¨ï¼ˆå…¥åŠ›é€šè²¨ï¼‰
      decimals: 0,
      // è‡ªå‹•å–å¾—ãƒ¬ãƒ¼ãƒˆï¼ˆ1 åŸºæº–é€šè²¨ = rate VNDï¼‰
      rateVND: 0,
      rateUpdatedAt: 0   // epoch(ms)
    };

    function load(){ try{ Object.assign(state, JSON.parse(localStorage.getItem(LS_KEY)||"{}")); }catch(e){} }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function saveRateCache(){ localStorage.setItem(RATE_CACHE_KEY, JSON.stringify({ rateVND: state.rateVND, at: Date.now(), base: state.currency })); }
    function loadRateCache(base){
      try{
        const c = JSON.parse(localStorage.getItem(RATE_CACHE_KEY)||"{}");
        if(c.base === base && c.rateVND > 0){ state.rateVND = c.rateVND; state.rateUpdatedAt = c.at || 0; }
      }catch(e){}
    }

    function lastDayOfMonth(y,m){ return new Date(y,m+1,0).getDate(); }
    function paydayDate(y,m,day){ return new Date(y,m,Math.min(day,lastDayOfMonth(y,m)),0,0,0,0); }
    function currentCycle(payday){
      const now=new Date(), y=now.getFullYear(), m=now.getMonth();
      const thisPay=paydayDate(y,m,payday);
      if(now>=thisPay){ return {start:thisPay,end:paydayDate(m===11?y+1:y,(m+1)%12,payday),now}; }
      else{ return {start:paydayDate(m===0?y-1:y,(m+11)%12,payday),end:thisPay,now}; }
    }
    function formatMoney(n,c,d){ try{ return new Intl.NumberFormat(navigator.language,{style:"currency",currency:c,minimumFractionDigits:d,maximumFractionDigits:d}).format(n);}catch(_){ return c+" "+n.toFixed(d); } }

    const amountEl=$("#amount"),noteEl=$("#subnote"),barEl=$("#bar"),coinsEl=$("#coins");
    let currentDisplay=0;

    function calcInstantEarning(){
      if(state.salary<=0) return {earned:0,progress:0,start:null,end:null,now:new Date()};
      const {start,end,now}=currentCycle(state.payday);
      const total=end-start, elapsed=Math.max(0,Math.min(now-start,total));
      return {earned:state.salary*elapsed/total,progress:elapsed/total,start,end,now};
    }

    // --- ç‚ºæ›¿ã®è‡ªå‹•å–å¾—ï¼ˆ1 base = ? VNDï¼‰ ---
    async function fetchRateVND(base){
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ24æ™‚é–“ï¼‰å„ªå…ˆ
      loadRateCache(base);
      const FRESH_MS = 24*60*60*1000;
      if(state.rateVND>0 && (Date.now()-state.rateUpdatedAt)<FRESH_MS){ return state.rateVND; }

      try{
        const url = `https://v6.exchangerate-api.com/v6/e51d4872933b3d1b16847887/pair/${encodeURIComponent(base)}/VND`;
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("rate fetch failed");
        const data = await res.json();
        const r = data && data.conversion_rate;
        if(r && isFinite(r)){
          state.rateVND = r;
          state.rateUpdatedAt = Date.now();
          saveRateCache();
          return r;
        }
        throw new Error("invalid rate");
      }catch(e){
        // å¤±æ•—æ™‚ã¯æœ€å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ï¼ˆãªã‘ã‚Œã°0ï¼‰
        return state.rateVND || 0;
      }
    }

    async function updateRateView(){
      const rate = await fetchRateVND(state.currency);
      const rateView = $("#rateView");
      if(rate>0){
        rateView.value = `1 ${state.currency} = ${new Intl.NumberFormat(navigator.language).format(rate)} VND`;
      }else{
        rateView.value = "æœªå–å¾—ï¼ˆå¾Œã§å†è©¦è¡Œï¼‰";
      }
    }

    function tick(){
      const {earned,progress,start,end,now}=calcInstantEarning();
      // è¡¨ç¤ºç”¨ã®ãªã‚ã‚‰ã‹è£œé–“
      currentDisplay += (earned - currentDisplay) * 0.08;

      // åŸºæº–é€šè²¨ â†’ VND ã¸æ›ç®—
      const rate = state.rateVND || 0;
      const shownVND = (state.currency === "VND") ? currentDisplay : (rate>0 ? currentDisplay * rate : 0);

      amountEl.textContent = formatMoney(shownVND, "VND", Number(state.decimals));
      barEl.style.width = (progress*100).toFixed(2) + "%";

      if(start && end){
        const remain=end-now, d=Math.floor(remain/86400000), h=Math.floor((remain%86400000)/3600000);
        const rateInfo = rate>0 ? `ï½œç‚ºæ›¿ 1 ${state.currency} = ${Math.round(rate).toLocaleString()} VND` : "ï½œç‚ºæ›¿å–å¾—å¾…ã¡";
        noteEl.textContent = `é€²æ— ${(progress*100).toFixed(2)}%ï½œæ¬¡çµ¦æ–™æ—¥ã¾ã§ æ®‹ã‚Š ${d}æ—¥${h}æ™‚é–“ ${rateInfo}`;
      }else{
        noteEl.textContent = `è¨­å®šã‹ã‚‰æœˆåã¨çµ¦æ–™æ—¥ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„`;
      }
      requestAnimationFrame(tick);
    }

    // --- ã‚³ã‚¤ãƒ³æ¼”å‡º ---
    // ã‚³ã‚¤ãƒ³æ¼”å‡ºï¼ˆ1ã‚³ã‚¤ãƒ³ = 1 VNDï¼‰ã€‚ç¨¼ãï¼ˆVND/msï¼‰ã‚’ç©ç®—ã—ã¦æ•´æ•°ã‚³ã‚¤ãƒ³ã‚’ç”Ÿæˆã€‚
    const conn=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
    // ä½é‹å‹•è¨­å®šã‚„çœãƒ‡ãƒ¼ã‚¿è¨­å®šã§ã¯ç”Ÿæˆã‚’æŠ‘ãˆã‚‹
    const REDUCED_MOTION = (conn&&conn.saveData) || window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let coinAccumulator = 0; // å°æ•°ã‚³ã‚¤ãƒ³ã‚’è“„ç©
    let lastCoinTs = null;
    let coinLoopActive = false;

    function spawnCoin(burst=false){
       const c = document.createElement("img");
       c.className = "coin";
       c.src = "coin.svg";
       const vw = innerWidth, vh = innerHeight;
       const cx = Math.round(vw/2);
       const jitter = (n) => (Math.random()*2-1)*n;
       // é–‹å§‹ä½ç½®ã¯ç”»é¢ä¸‹ç«¯ã®ä¸­å¤®ä»˜è¿‘ã‹ã‚‰ï¼ˆä¸­å¤®ã‹ã‚‰å¤–å´ã¸åºƒãŒã‚‹ï¼‰
       // ä¸­å¤®ã«è¿‘ã„ã»ã©å¤–å´ã¸ã®åºƒãŒã‚ŠãŒè¦–èªã—ã‚„ã™ããªã‚‹ã®ã§ jitter ã¯å°ã•ã‚ã«ã™ã‚‹
       const startLeft = cx + Math.round(jitter(12));
       const startTop = Math.round(vh - 12 + jitter(6)); // ã»ã¼ä¸‹ç«¯
       c.style.left = startLeft + "px";
       c.style.top = startTop + "px";
       // æ¨ªæ–¹å‘ã®ç§»å‹•: ä¸­å¿ƒã‹ã‚‰ã®ä½ç½®å·®ã«å¿œã˜ã¦å¤–å´æ–¹å‘ã¸åã‚‰ã›ã‚‹
       const baseSpread = burst ? 100 : 220; // é©åº¦ã«åºƒãŒã‚‹å€¤
       // å¤–å´æ–¹å‘ã«å¼·ã‚ã®ç§»å‹•ã‚’ã•ã›ã‚‹ãŸã‚ã€é–‹å§‹ä½ç½®ãŒå³å´ãªã‚‰æ­£ã€å·¦å´ãªã‚‰è² ã®å€¤ã‚’ä½¿ã†
       const dir = (startLeft >= cx) ? 1 : -1;
       const magnitude = (Math.random() * baseSpread) + (baseSpread * 0.25); // æœ€ä½ã§ã‚‚ baseSpread*0.25 ä»¥ä¸Š
       c.style.setProperty('--x', (dir * magnitude) + 'px');
       // å°‘ã—å°ã•ã‚ã®ã‚³ã‚¤ãƒ³ã§å¤šãè¡¨ç¤ºã—ã¦ã‚‚é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
       c.style.setProperty('--s', (0.45 + Math.random()*0.7).toString());
       // ç”»é¢ä¸Šç«¯ã¾ã§ä¸ŠãŒã‚‹ã‚ˆã†ã«ç”»é¢é«˜ã• + ãƒãƒ¼ã‚¸ãƒ³
       c.style.setProperty('--rise', (vh + 160) + 'px');
       // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’ã•ã‚‰ã«é•·ã‚ã«ã—ã¦ä¸Šæ˜‡ã‚’ã‚†ã£ãã‚Šã«ã™ã‚‹ï¼ˆ3.5ã€œ6.0sï¼‰
       c.style.setProperty('--duration', (3.5 + Math.random()*2.5) + 's');
       coinsEl.appendChild(c);
       c.addEventListener('animationend', () => c.remove());
     }
    // ç¾åœ¨ã®ç¨¼ãï¼ˆVND/msï¼‰ã‚’è¿”ã™
    function earnPerMsVND(){
      if(state.salary <= 0) return 0;
      const {start,end} = currentCycle(state.payday);
      const total = end - start;
      if(!total) return 0;
      const perMsBase = state.salary / total; // åŸºæº–é€šè²¨ / ms
      const rate = (state.currency === 'VND') ? 1 : (state.rateVND || 0);
      return perMsBase * rate; // VND / ms
    }

    function coinLoop(ts){
      if(!coinLoopActive) return;
      if(lastCoinTs == null) lastCoinTs = ts;
      const dt = Math.min(200, ts - lastCoinTs); // ç•°å¸¸ãªå¤§ãã•ã‚’é˜²ã
      lastCoinTs = ts;
      // ä½é‹å‹•è¨­å®šã§ã¯ç”Ÿæˆã‚’æŠ‘ãˆã‚‹
      if(REDUCED_MOTION){ requestAnimationFrame(coinLoop); return; }

      const perMs = earnPerMsVND();
      coinAccumulator += perMs * dt;
      // å®‰å…¨ä¸Šã®ä¸Šé™
      if(coinAccumulator > 5000) coinAccumulator = 5000;
      while(coinAccumulator >= 1){
        spawnCoin(false);
        coinAccumulator -= 1;
      }
      requestAnimationFrame(coinLoop);
    }

    function startCoinLoop(){ if(!coinLoopActive){ coinLoopActive = true; lastCoinTs = null; requestAnimationFrame(coinLoop); } }
    function stopCoinLoop(){ coinLoopActive = false; lastCoinTs = null; coinAccumulator = 0; }

    // --- UIé…ç·š ---
    const modalEl = $("#modal");
    const modal = new bootstrap.Modal(modalEl);
    const salaryI=$("#salary"),paydayI=$("#payday"),currencyI=$("#currency"),decimalsI=$("#decimals");
    $("#btn-settings").onclick=()=>{salaryI.value=state.salary||"";paydayI.value=state.payday||25;currencyI.value=state.currency||"JPY";decimalsI.value=state.decimals??0;$("#rateView").value="å–å¾—ä¸­â€¦";modal.show();updateRateView();};
    $("#btn-cancel").onclick=()=>modal.hide();
    $("#btn-save").onclick=async ()=>{
      const s=+salaryI.value,p=Math.max(1,Math.min(31,+paydayI.value)),dec=+decimalsI.value;
      if(!s){alert("æœˆåã‚’æ­£ã—ãå…¥åŠ›");return;}
      const base = currencyI.value;
      Object.assign(state,{salary:s,payday:p,currency:base,decimals:dec});
      // ä¿å­˜ç›´å‰ã«æœ€æ–°ãƒ¬ãƒ¼ãƒˆã‚‚åæ˜ 
      await updateRateView();
      save(); modal.hide();
      // ãƒãƒ¼ã‚¹ãƒˆ: ä¸­å¤®ã‹ã‚‰å¤–å´ã¸åºƒãŒã‚‹å¤šã‚ã®ã‚³ã‚¤ãƒ³
      for(let i=0;i<28;i++) setTimeout(()=>spawnCoin(true), i*30);
    };
    $("#btn-boost").onclick=()=>{ for(let i=0;i<26;i++) setTimeout(()=>spawnCoin(true), i*28); };

    // åˆæœŸåŒ–
    load();
    startCoinLoop();
    requestAnimationFrame(()=>tick());
    document.addEventListener("visibilitychange",()=>{document.hidden?stopCoinLoop():startCoinLoop();});

    // åˆå›ãƒ¬ãƒ¼ãƒˆå–å¾—ï¼ˆåŸºæº–é€šè²¨ãŒVNDä»¥å¤–ãªã‚‰ï¼‰
    (async ()=>{ if(state.currency!=="VND"){ await updateRateView(); save(); }})();
    if(!state.salary) modal.show();
  </script>
</body>
</html>
