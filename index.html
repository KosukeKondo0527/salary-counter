<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ä»Šæœˆã„ãã‚‰ç¨¼ã„ã ï¼Ÿ</title>
  <meta name="theme-color" content="#0b0c10">
  <!-- iOS: ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ã§å…¨ç”»é¢ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Android Chrome (A2HSã§ã®UIè‰²) -->
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    :root {
      --bg: #0e0f13;
      --fg: #f7f8fa;
      --muted: #9aa0a6;
      --accent: #ffd54f;
      --glass: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.12);
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 800px at 50% 20%, #151823, #0b0c10);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .counter-card{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      min-width: min(92vw, 700px);
      padding: clamp(20px, 6vw, 48px);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
      text-align:center;
    }
    .title{
      font-size: clamp(14px, 2.5vw, 16px);
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .amount{
      font-variant-numeric: tabular-nums;
      font-weight:800;
      line-height:1.1;
      font-size: clamp(34px, 10vw, 80px);
      text-shadow: 0 3px 14px rgba(0,0,0,.25);
    }
    .note{
      font-size: clamp(12px, 2.7vw, 14px);
      color: var(--muted);
    }
    .progress{
      width:100%;
      height:10px;
      background: var(--glass);
      border-radius:999px;
      overflow:hidden;
      margin-top:.8rem;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #ffd54f, #ff9f1c);
      box-shadow: 0 0 18px rgba(255,165,0,.45);
      transition: width .2s linear;
    }
    .chrome{
      position:absolute;
      top:16px; right:16px;
      display:flex; gap:10px;
      z-index:5;
    }
    .btn{
      appearance:none; border:0;
      background: var(--glass-strong);
      color:var(--fg);
      padding:.8rem 1rem;
      border-radius:12px;
      font-weight:600;
      backdrop-filter: blur(10px);
      font-size:15px;
    }
    .btn:active{ transform: translateY(1px); }

    /* è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    .modal{
      position:fixed; inset:0;
      display:none; place-items:center;
      background: rgba(0,0,0,.45);
      z-index:10;
      padding:16px;
    }
    .modal[open]{ display:grid; }
    .panel{
      width:min(92vw,520px);
      background:#12131a;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .panel h2{ margin:0 0 12px; font-size:18px; }
    .grid{
      display:grid; gap:12px; grid-template-columns:1fr 1fr;
    }
    .grid label{
      display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted);
    }
    .grid input, .grid select{
      background:#0e0f13; color:var(--fg);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:.7rem .8rem; font-size:14px;
    }
    .row{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }

    /* ã‚³ã‚¤ãƒ³ã˜ã‚ƒã°ã˜ã‚ƒã° */
    .coins{
      position:absolute; inset:0; pointer-events:none; overflow:hidden;
    }
    .coin{
      position:absolute;
      font-size: clamp(16px, 5vw, 28px);
      will-change: transform, opacity;
      filter: drop-shadow(0 6px 6px rgba(0,0,0,.25));
      animation: floatUp 1.6s ease-out forwards, spin 1.6s linear forwards;
      opacity:0;
    }
    @keyframes floatUp{
      0%{ transform: translate(var(--x,0), var(--y,0)) scale(.8); opacity:0; }
      8%{ opacity:1; }
      70%{ opacity:1; }
      100%{ transform: translate(calc(var(--x,0) * 1.1), calc(var(--y,0) - 160px)) scale(1); opacity:0; }
    }
    @keyframes spin{
      from{ transform: rotate(0turn); }
      to{ transform: rotate(1turn); }
    }
    @media (prefers-reduced-motion: reduce) {
      .coin { animation-duration: 1.0s; }
    }
    @media (max-width: 480px){
      .panel{ width:100%; height:100%; border-radius:0; padding:22px; }
    }
    *{ -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="chrome">
      <button class="btn" id="btn-settings" aria-label="è¨­å®šã‚’é–‹ã">âš™ï¸ è¨­å®š</button>
      <button class="btn" id="btn-boost" aria-label="ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™">ğŸª™ ã˜ã‚ƒã°ã˜ã‚ƒã°</button>
    </div>

    <div class="counter-card" aria-live="polite">
      <div class="title">ä»Šæœˆã®ç²å¾—é¡ï¼ˆçµ¦æ–™æ—¥ã‚µã‚¤ã‚¯ãƒ«åŸºæº–ï¼‰</div>
      <div class="amount" id="amount">Â¥0</div>
      <div class="note" id="subnote">è¨­å®šã‹ã‚‰æœˆåã¨çµ¦æ–™æ—¥ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <div class="coins" id="coins"></div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog class="modal" id="modal">
    <div class="panel">
      <h2>è¨­å®š</h2>
      <div class="grid">
        <label>
          æœˆå
          <input id="salary" type="number" inputmode="decimal" min="0" step="1000" placeholder="ä¾‹: 400000">
        </label>
        <label>
          é€šè²¨
          <select id="currency">
            <option value="JPY" selected>JPYï¼ˆå††ï¼‰</option>
            <option value="USD">USDï¼ˆ$ï¼‰</option>
            <option value="EUR">EURï¼ˆâ‚¬ï¼‰</option>
          </select>
        </label>
        <label>
          çµ¦æ–™æ—¥ï¼ˆæ¯æœˆã®â—‹æ—¥ï¼‰
          <input id="payday" type="number" inputmode="numeric" min="1" max="31" placeholder="ä¾‹: 25">
        </label>
        <label>
          å°æ•°è¡¨ç¤º
          <select id="decimals">
            <option value="0" selected>ã—ãªã„</option>
            <option value="2">2æ¡</option>
          </select>
        </label>
      </div>
      <div class="hint">â€» çµ¦æ–™æ—¥ã¯ã€Œâ—‹æ—¥æ‰•ã„ã€ã®â—‹æ—¥ã€‚28æ—¥æœªæº€ã®æœˆã¯è‡ªå‹•èª¿æ•´ã€‚</div>
      <div class="row">
        <button class="btn" id="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" id="btn-save">ä¿å­˜</button>
      </div>
    </div>
  </dialog>

  <script>
    const LS_KEY = "earning-counter:v1";
    const $ = (sel) => document.querySelector(sel);

    const state = { salary: 0, payday: 25, currency: "JPY", decimals: 0 };

    function load(){ try{ Object.assign(state, JSON.parse(localStorage.getItem(LS_KEY)||"{}")); }catch(e){} }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function lastDayOfMonth(y,m){ return new Date(y,m+1,0).getDate(); }
    function paydayDate(y,m,day){ return new Date(y,m,Math.min(day,lastDayOfMonth(y,m)),0,0,0,0); }
    function currentCycle(payday){
      const now=new Date(), y=now.getFullYear(), m=now.getMonth();
      const thisPay=paydayDate(y,m,payday);
      if(now>=thisPay){ return {start:thisPay,end:paydayDate(m===11?y+1:y,(m+1)%12,payday),now}; }
      else{ return {start:paydayDate(m===0?y-1:y,(m+11)%12,payday),end:thisPay,now}; }
    }
    function formatMoney(n,c,d){ try{return new Intl.NumberFormat(navigator.language,{style:"currency",currency:c,minimumFractionDigits:d,maximumFractionDigits:d}).format(n);}catch(_){return c+" "+n.toFixed(d);} }

    const amountEl=$("#amount"),noteEl=$("#subnote"),barEl=$("#bar"),coinsEl=$("#coins");
    let lastFrame=performance.now(), currentDisplay=0;

    function calcInstantEarning(){
      if(state.salary<=0) return {earned:0,progress:0,start:null,end:null,now:new Date()};
      const {start,end,now}=currentCycle(state.payday);
      const total=end-start, elapsed=Math.max(0,Math.min(now-start,total));
      return {earned:state.salary*elapsed/total,progress:elapsed/total,start,end,now};
    }
    function tick(t){
      const {earned,progress,start,end,now}=calcInstantEarning();
      currentDisplay+= (earned-currentDisplay)*0.08;
      amountEl.textContent=formatMoney(currentDisplay,state.currency,Number(state.decimals));
      barEl.style.width=(progress*100).toFixed(2)+"%";
      if(start&&end){
        const remain=end-now, d=Math.floor(remain/86400000), h=Math.floor((remain%86400000)/3600000);
        noteEl.textContent=`é€²æ— ${(progress*100).toFixed(2)}%ï½œæ¬¡çµ¦æ–™æ—¥ã¾ã§ æ®‹ã‚Š ${d}æ—¥${h}æ™‚é–“`;
      }
      requestAnimationFrame(tick);
    }

    let coinTimer=null, COIN_INTERVAL_MS=160;
    const conn=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
    if((conn&&conn.saveData)||window.matchMedia('(prefers-reduced-motion: reduce)').matches){ COIN_INTERVAL_MS=300; }
    if('deviceMemory'in navigator && navigator.deviceMemory<=2){ COIN_INTERVAL_MS=Math.max(COIN_INTERVAL_MS,360); }

    function spawnCoin(burst=false){
      const c=document.createElement("div"); c.className="coin"; c.textContent="ğŸª™";
      const vw=window.innerWidth,vh=window.innerHeight,cx=vw/2,cy=vh/2;
      const jitter=(n)=> (Math.random()*2-1)*n;
      c.style.left=(cx+jitter(burst?140:70))+"px";
      c.style.top=(cy+jitter(burst?140:70))+"px";
      c.style.setProperty("--x",(Math.random()*60-30)+"px");
      c.style.setProperty("--y",(Math.random()*20+10)+"px");
      c.style.transform=`translate(-50%,-50%) scale(${0.8+Math.random()*0.5})`;
      coinsEl.appendChild(c);
      c.addEventListener("animationend",()=>c.remove());
    }
    function startCoins(){ stopCoins(); coinTimer=setInterval(()=>spawnCoin(false),COIN_INTERVAL_MS); }
    function stopCoins(){ if(coinTimer) clearInterval(coinTimer); coinTimer=null; }

    const modal=$("#modal"),salaryI=$("#salary"),paydayI=$("#payday"),currencyI=$("#currency"),decimalsI=$("#decimals");
    $("#btn-settings").onclick=()=>{salaryI.value=state.salary||"";paydayI.value=state.payday||25;currencyI.value=state.currency;decimalsI.value=state.decimals;modal.setAttribute("open","");};
    $("#btn-cancel").onclick=()=>modal.removeAttribute("open");
    $("#btn-save").onclick=()=>{
      const s=+salaryI.value,p=Math.max(1,Math.min(31,+paydayI.value)),dec=+decimalsI.value;
      if(!s){alert("æœˆåã‚’æ­£ã—ãå…¥åŠ›");return;}
      Object.assign(state,{salary:s,payday:p,currency:currencyI.value,decimals:dec}); save(); modal.removeAttribute("open");
      for(let i=0;i<18;i++) setTimeout(()=>spawnCoin(true),i*20);
    };
    $("#btn-boost").onclick=()=>{for(let i=0;i<14;i++) setTimeout(()=>spawnCoin(true),i*18);};

    load(); if(!state.salary) modal.setAttribute("open","");
    startCoins(); requestAnimationFrame((t)=>{lastFrame=t; tick(t);});
    document.addEventListener("visibilitychange",()=>{document.hidden?stopCoins():startCoins();});
  </script>
</body>
</html>
