<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ä»Šæœˆã„ãã‚‰ç¨¼ã„ã ï¼Ÿï¼ˆVNDæ›ç®—ï¼‰</title>
  <meta name="theme-color" content="#0b0c10">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root{--bg:#0e0f13;--fg:#f7f8fa;--muted:#9aa0a6;--accent:#ffd54f;--glass:rgba(255,255,255,.06);--glass-strong:rgba(255,255,255,.12)}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 20%,#151823,#0b0c10);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji")}
    .wrap{position:relative;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
    .counter-card{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem;min-width:min(92vw,700px);padding:clamp(20px,6vw,48px);border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));box-shadow:0 10px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06);backdrop-filter:blur(8px);text-align:center}
    .title{font-size:clamp(14px,2.5vw,16px);letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .amount{font-variant-numeric:tabular-nums;font-weight:800;line-height:1.1;font-size:clamp(34px,10vw,80px);text-shadow:0 3px 14px rgba(0,0,0,.25)}
    .note{font-size:clamp(12px,2.7vw,14px);color:var(--muted)}
    .progress{width:100%;height:10px;background:var(--glass);border-radius:999px;overflow:hidden;margin-top:.8rem}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#ffd54f,#ff9f1c);box-shadow:0 0 18px rgba(255,165,0,.45);transition:width .2s linear}
    .chrome{position:absolute;top:16px;right:16px;display:flex;gap:10px;z-index:5}
    .btn{appearance:none;border:0;background:var(--glass-strong);color:var(--fg);padding:.8rem 1rem;border-radius:12px;font-weight:600;backdrop-filter:blur(10px);font-size:15px}
    .btn:active{transform:translateY(1px)}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:10;padding:16px}
    .modal[open]{display:grid}
    .panel{width:min(92vw,520px);background:#12131a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h2{margin:0 0 12px;font-size:18px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .grid label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    .grid input,.grid select{background:#0e0f13;color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:.7rem .8rem;font-size:14px}
    .row{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .coins{position:absolute;inset:0;pointer-events:none;overflow:hidden}
    .coin{position:absolute;font-size:clamp(16px,5vw,28px);will-change:transform,opacity;filter:drop-shadow(0 6px 6px rgba(0,0,0,.25));animation:floatUp 1.6s ease-out forwards,spin 1.6s linear forwards;opacity:0}
    @keyframes floatUp{0%{transform:translate(var(--x,0),var(--y,0)) scale(.8);opacity:0}8%{opacity:1}70%{opacity:1}100%{transform:translate(calc(var(--x,0) * 1.1),calc(var(--y,0) - 160px)) scale(1);opacity:0}}
    @keyframes spin{from{transform:rotate(0turn)}to{transform:rotate(1turn)}}
    @media (prefers-reduced-motion:reduce){.coin{animation-duration:1.0s}}
    @media (max-width:480px){.panel{width:100%;height:100%;border-radius:0;padding:22px}}
    *{-webkit-tap-highlight-color:transparent}
    .provider{position:absolute;left:16px;bottom:12px;color:var(--muted);font-size:11px;opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="chrome">
      <button class="btn" id="btn-settings" aria-label="è¨­å®šã‚’é–‹ã">âš™ï¸ è¨­å®š</button>
      <button class="btn" id="btn-boost" aria-label="ã‚³ã‚¤ãƒ³ã‚’å¢—ã‚„ã™">ğŸª™ ã˜ã‚ƒã°ã˜ã‚ƒã°</button>
    </div>

    <div class="counter-card" aria-live="polite">
      <div class="title">ä»Šæœˆã®ç²å¾—é¡ï¼ˆçµ¦æ–™æ—¥ã‚µã‚¤ã‚¯ãƒ«åŸºæº–ï½œè¡¨ç¤º: VNDï¼‰</div>
      <div class="amount" id="amount">â‚«0</div>
      <div class="note" id="subnote">è¨­å®šã‹ã‚‰æœˆåãƒ»çµ¦æ–™æ—¥ãƒ»åŸºæº–é€šè²¨ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <div class="coins" id="coins"></div>
    <div class="provider">FX data: exchangerate.hostï¼ˆå‚è€ƒãƒ¬ãƒ¼ãƒˆï¼‰</div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog class="modal" id="modal">
    <div class="panel">
      <h2>è¨­å®š</h2>
      <div class="grid">
        <label>æœˆå
          <input id="salary" type="number" inputmode="decimal" min="0" step="1000" placeholder="ä¾‹: 400000">
        </label>
        <label>åŸºæº–é€šè²¨ï¼ˆå…¥åŠ›ã®é€šè²¨ï¼‰
          <select id="currency">
            <option value="JPY" selected>JPYï¼ˆå††ï¼‰</option>
            <option value="USD">USDï¼ˆ$ï¼‰</option>
            <option value="EUR">EURï¼ˆâ‚¬ï¼‰</option>
            <option value="VND">VNDï¼ˆâ‚«ï¼‰</option>
          </select>
        </label>
        <label>çµ¦æ–™æ—¥ï¼ˆæ¯æœˆã®â—‹æ—¥ï¼‰
          <input id="payday" type="number" inputmode="numeric" min="1" max="31" placeholder="ä¾‹: 25">
        </label>
        <label>å°æ•°è¡¨ç¤º
          <select id="decimals">
            <option value="0" selected>ã—ãªã„</option>
            <option value="2">2æ¡</option>
          </select>
        </label>
        <label>è¡¨ç¤ºé€šè²¨ï¼ˆå›ºå®šï¼‰
          <input value="VND" disabled>
        </label>
        <label>ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆ
          <input id="rateView" disabled placeholder="è‡ªå‹•å–å¾—ä¸­â€¦">
        </label>
      </div>
      <div class="hint">â€» ãƒ¬ãƒ¼ãƒˆã¯exchangerate.hostã‹ã‚‰è‡ªå‹•å–å¾—ï¼ˆå‚è€ƒå€¤ï¼‰ã€‚å–å¾—å¤±æ•—æ™‚ã®ã¿æœ€å¾Œã®ä¿å­˜å€¤ã‚’ä½¿ç”¨ã€‚</div>
      <div class="row">
        <button class="btn" id="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" id="btn-save">ä¿å­˜</button>
      </div>
    </div>
  </dialog>

  <script>
    const LS_KEY = "earning-counter:v2"; // v2: VNDè‡ªå‹•ãƒ¬ãƒ¼ãƒˆå¯¾å¿œ
    const RATE_CACHE_KEY = "earning-rate-cache:vnd";
    const $ = (sel) => document.querySelector(sel);

    const state = {
      salary: 0,         // å…¥åŠ›æœˆåï¼ˆåŸºæº–é€šè²¨å»ºã¦ï¼‰
      payday: 25,
      currency: "JPY",   // åŸºæº–é€šè²¨ï¼ˆå…¥åŠ›é€šè²¨ï¼‰
      decimals: 0,
      // è‡ªå‹•å–å¾—ãƒ¬ãƒ¼ãƒˆï¼ˆ1 åŸºæº–é€šè²¨ = rate VNDï¼‰
      rateVND: 0,
      rateUpdatedAt: 0   // epoch(ms)
    };

    function load(){ try{ Object.assign(state, JSON.parse(localStorage.getItem(LS_KEY)||"{}")); }catch(e){} }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function saveRateCache(){ localStorage.setItem(RATE_CACHE_KEY, JSON.stringify({ rateVND: state.rateVND, at: Date.now(), base: state.currency })); }
    function loadRateCache(base){
      try{
        const c = JSON.parse(localStorage.getItem(RATE_CACHE_KEY)||"{}");
        if(c.base === base && c.rateVND > 0){ state.rateVND = c.rateVND; state.rateUpdatedAt = c.at || 0; }
      }catch(e){}
    }

    function lastDayOfMonth(y,m){ return new Date(y,m+1,0).getDate(); }
    function paydayDate(y,m,day){ return new Date(y,m,Math.min(day,lastDayOfMonth(y,m)),0,0,0,0); }
    function currentCycle(payday){
      const now=new Date(), y=now.getFullYear(), m=now.getMonth();
      const thisPay=paydayDate(y,m,payday);
      if(now>=thisPay){ return {start:thisPay,end:paydayDate(m===11?y+1:y,(m+1)%12,payday),now}; }
      else{ return {start:paydayDate(m===0?y-1:y,(m+11)%12,payday),end:thisPay,now}; }
    }
    function formatMoney(n,c,d){ try{ return new Intl.NumberFormat(navigator.language,{style:"currency",currency:c,minimumFractionDigits:d,maximumFractionDigits:d}).format(n);}catch(_){ return c+" "+n.toFixed(d); } }

    const amountEl=$("#amount"),noteEl=$("#subnote"),barEl=$("#bar"),coinsEl=$("#coins");
    let currentDisplay=0;

    function calcInstantEarning(){
      if(state.salary<=0) return {earned:0,progress:0,start:null,end:null,now:new Date()};
      const {start,end,now}=currentCycle(state.payday);
      const total=end-start, elapsed=Math.max(0,Math.min(now-start,total));
      return {earned:state.salary*elapsed/total,progress:elapsed/total,start,end,now};
    }

    // --- ç‚ºæ›¿ã®è‡ªå‹•å–å¾—ï¼ˆ1 base = ? VNDï¼‰ ---
    async function fetchRateVND(base){
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ6æ™‚é–“ï¼‰å„ªå…ˆ
      loadRateCache(base);
      const FRESH_MS = 6*60*60*1000;
      if(state.rateVND>0 && (Date.now()-state.rateUpdatedAt)<FRESH_MS){ return state.rateVND; }

      try{
        const url = `https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=VND`;
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("rate fetch failed");
        const data = await res.json();
        const r = data && data.rates && data.rates.VND;
        if(r && isFinite(r)){
          state.rateVND = r;
          state.rateUpdatedAt = Date.now();
          saveRateCache();
          return r;
        }
        throw new Error("invalid rate");
      }catch(e){
        // å¤±æ•—æ™‚ã¯æœ€å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ï¼ˆãªã‘ã‚Œã°0ï¼‰
        return state.rateVND || 0;
      }
    }

    async function updateRateView(){
      const rate = await fetchRateVND(state.currency);
      const rateView = $("#rateView");
      if(rate>0){
        rateView.value = `1 ${state.currency} = ${new Intl.NumberFormat(navigator.language).format(rate)} VND`;
      }else{
        rateView.value = "æœªå–å¾—ï¼ˆå¾Œã§å†è©¦è¡Œï¼‰";
      }
    }

    function tick(){
      const {earned,progress,start,end,now}=calcInstantEarning();
      // è¡¨ç¤ºç”¨ã®ãªã‚ã‚‰ã‹è£œé–“
      currentDisplay += (earned - currentDisplay) * 0.08;

      // åŸºæº–é€šè²¨ â†’ VND ã¸æ›ç®—
      const rate = state.rateVND || 0;
      const shownVND = (state.currency === "VND") ? currentDisplay : (rate>0 ? currentDisplay * rate : 0);

      amountEl.textContent = formatMoney(shownVND, "VND", Number(state.decimals));
      barEl.style.width = (progress*100).toFixed(2) + "%";

      if(start && end){
        const remain=end-now, d=Math.floor(remain/86400000), h=Math.floor((remain%86400000)/3600000);
        const rateInfo = rate>0 ? `ï½œç‚ºæ›¿ 1 ${state.currency} = ${Math.round(rate).toLocaleString()} VND` : "ï½œç‚ºæ›¿å–å¾—å¾…ã¡";
        noteEl.textContent = `é€²æ— ${(progress*100).toFixed(2)}%ï½œæ¬¡çµ¦æ–™æ—¥ã¾ã§ æ®‹ã‚Š ${d}æ—¥${h}æ™‚é–“ ${rateInfo}`;
      }else{
        noteEl.textContent = `è¨­å®šã‹ã‚‰æœˆåã¨çµ¦æ–™æ—¥ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„`;
      }
      requestAnimationFrame(tick);
    }

    // --- ã‚³ã‚¤ãƒ³æ¼”å‡º ---
    let coinTimer=null, COIN_INTERVAL_MS=160;
    const conn=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
    if((conn&&conn.saveData)||window.matchMedia('(prefers-reduced-motion: reduce)').matches){ COIN_INTERVAL_MS=300; }
    if('deviceMemory'in navigator && navigator.deviceMemory<=2){ COIN_INTERVAL_MS=Math.max(COIN_INTERVAL_MS,360); }
    function spawnCoin(burst=false){
      const c=document.createElement("div"); c.className="coin"; c.textContent="ğŸª™";
      const vw=innerWidth,vh=innerHeight,cx=vw/2,cy=vh/2;
      const jitter=(n)=> (Math.random()*2-1)*n;
      c.style.left=(cx+jitter(burst?140:70))+"px";
      c.style.top=(cy+jitter(burst?140:70))+"px";
      c.style.setProperty("--x",(Math.random()*60-30)+"px");
      c.style.setProperty("--y",(Math.random()*20+10)+"px");
      c.style.transform=`translate(-50%,-50%) scale(${0.8+Math.random()*0.5})`;
      coinsEl.appendChild(c);
      c.addEventListener("animationend",()=>c.remove());
    }
    function startCoins(){ stopCoins(); coinTimer=setInterval(()=>spawnCoin(false),COIN_INTERVAL_MS); }
    function stopCoins(){ if(coinTimer) clearInterval(coinTimer); coinTimer=null; }

    // --- UIé…ç·š ---
    const modal=$("#modal"),salaryI=$("#salary"),paydayI=$("#payday"),currencyI=$("#currency"),decimalsI=$("#decimals");
    $("#btn-settings").onclick=()=>{salaryI.value=state.salary||"";paydayI.value=state.payday||25;currencyI.value=state.currency||"JPY";decimalsI.value=state.decimals??0;$("#rateView").value="å–å¾—ä¸­â€¦";modal.setAttribute("open","");updateRateView();};
    $("#btn-cancel").onclick=()=>modal.removeAttribute("open");
    $("#btn-save").onclick=async ()=>{
      const s=+salaryI.value,p=Math.max(1,Math.min(31,+paydayI.value)),dec=+decimalsI.value;
      if(!s){alert("æœˆåã‚’æ­£ã—ãå…¥åŠ›");return;}
      const base = currencyI.value;
      Object.assign(state,{salary:s,payday:p,currency:base,decimals:dec});
      // ä¿å­˜ç›´å‰ã«æœ€æ–°ãƒ¬ãƒ¼ãƒˆã‚‚åæ˜ 
      await updateRateView();
      save(); modal.removeAttribute("open");
      for(let i=0;i<18;i++) setTimeout(()=>spawnCoin(true),i*20);
    };
    $("#btn-boost").onclick=()=>{for(let i=0;i<14;i++) setTimeout(()=>spawnCoin(true),i*18);};

    // åˆæœŸåŒ–
    load();
    startCoins();
    requestAnimationFrame(()=>tick());
    document.addEventListener("visibilitychange",()=>{document.hidden?stopCoins():startCoins();});

    // åˆå›ãƒ¬ãƒ¼ãƒˆå–å¾—ï¼ˆåŸºæº–é€šè²¨ãŒVNDä»¥å¤–ãªã‚‰ï¼‰
    (async ()=>{ if(state.currency!=="VND"){ await updateRateView(); save(); }})();
    if(!state.salary) modal.setAttribute("open","");
  </script>
</body>
</html>
